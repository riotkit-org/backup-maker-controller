{{ $pgVersions := list "pg11" "pg12" "pg13" "pg14" }}

{{ range $num, $pgVersion := $pgVersions }}
---
apiVersion: riotkit.org/v1alpha1
kind: ClusterBackupProcedureTemplate
metadata:
    name: {{ $pgVersion }}
    labels:
        {{- include "controller.labels" $ | nindent 8 }}
spec:
    image: ghcr.io/riotkit-org/pgbr:latest-{{ $pgVersion }}.0
    backup: |
        #!/bin/sh
        # Generated by `bmg backup`
        # Docs: https://github.com/riotkit-org/br-backup-maker
        
        set -eu

        COMMAND="pgbr db backup --password '{{ "{{" }} .Params.password }}' --user '{{ "{{" }} .Params.user }}' --db-name '{{ "{{" }} .Params.db }}' --port '{{ "{{" }} .Params.port }}' --host '{{ "{{" }} .Params.hostname }}'";
        
        export BM_AUTH_TOKEN="{{ "{{" }} .Repository.token }}";
        export BM_COLLECTION_ID="{{ "{{" }} .Repository.collectionId }}";
        export BM_PASSPHRASE="{{ "{{" }} .Repository.passphrase }}";
        
        echo " >> Executing backup command and uploading piped result"
        
        exec backup-maker make --url "{{ "{{" }} .Repository.url }}" \
            -c "${COMMAND}" \
            --key {{ "{{" }} .Repository.encryptionKeyPath }} \
            --recipient {{ "{{" }} .Repository.recipient }}\
            --log-level info
    restore: |
        #!/bin/sh
        # Generated by `bmg restore`
        # Docs: https://github.com/riotkit-org/br-backup-maker
        
        set -eu
        
        COMMAND="pgbr db restore --password '{{ "{{" }} .Params.password }}' --user '{{ "{{" }} .Params.user }}' --db-name '{{ "{{" }} .Params.db }}' --port '{{ "{{" }} .Params.port }}' --host '{{ "{{" }} .Params.hostname }}'";
        selectedVersion="${RESTORE_VERSION:-latest}"
        
        export BM_AUTH_TOKEN="{{ "{{" }} .Repository.token }}";
        export BM_COLLECTION_ID="{{ "{{" }} .Repository.collectionId }}";
        export BM_PASSPHRASE="{{ "{{" }} .Repository.passphrase }}";
        
        echo " >> Executing restore command and uploading piped result"
        echo " >> Restoring version: ${selectedVersion}"
        
        exec backup-maker restore --url "{{ "{{" }} .Repository.url }}" \
            -c "${COMMAND}" \
            --private-key {{ "{{" }} .Repository.encryptionKeyPath }} \
            --recipient {{ "{{" }} .Repository.recipient }}\
            --log-level info \
            --version=${selectedVersion}
{{ end }}
